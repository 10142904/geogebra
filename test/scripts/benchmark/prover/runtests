#!/bin/sh
# Creates a benchmark output for the prover in CSV format to stdout
# @author Zoltan Kovacs <zoltan@geogebra.org>

DEBUG=1
TIMEOUT=20
HTML=html/index.html
PROVERS="Botana Recio PureSymbolic"
THISDIR=`dirname $0`
MYDIR=`cd $THISDIR; pwd`
mkdir -p $MYDIR/tmp $MYDIR/html
LOGFILE=$MYDIR/tmp/.test.log
REGRESSIONFILE=$MYDIR/tmp/.regression.out
rm -f $HTML

BUILDDIR=../../../../desktop/build
test -r $BUILDDIR/geogebra.jar || exit 1 # Non-existing JAR

# Heading
echo -n "Filename;"
echo "<table border=\"1\"><tr><th>Filename</th>" >> $MYDIR/$HTML
for j in $PROVERS; do
 echo -n "$j result;Speed;"
 echo "<th>$j result</th><th>Speed</th>" >> $MYDIR/$HTML
 done
echo
echo "</tr>" >> $MYDIR/$HTML

# Content
for i in *.ggb; do
 # Creating thumbnail:
 cd $MYDIR
 unzip $i geogebra_thumbnail.png >/dev/null 2>&1
 mv geogebra_thumbnail.png html/$i.png
 echo -n "$i;"
 echo "<tr><td><img src=\"$i.png\"><br>$i</td>" >> $MYDIR/$HTML
 for j in $PROVERS; do
  cd $MYDIR; cd $BUILDDIR
  # Testing:
  timeout $TIMEOUT java -jar geogebra.jar --prover=engine:$j --logFile=$LOGFILE \
   --regressionFile=$REGRESSIONFILE $MYDIR/$i --language=en \
   >$MYDIR/tmp/.test.stdout 2>$MYDIR/tmp/.test.stderr
  
  RETVAL=$?
  if [ $RETVAL = 124 ]; then
   RESULT=""
   TIME=timeout
  else
   # Regression out file shows the wrong result (the stored value in the file is shown):
   # RESULT=`cat $REGRESSIONFILE | grep Prove | sed 's/\(.*\) = \(.*\)/\2/'`
   RESULT=`cat $LOGFILE | grep "Statement is " | sed 's/\(.*\)Statement is \(.*\)/\2/'`
   TIME=`cat $LOGFILE | grep Benchmarking | awk '{print $5}'`
   if [ $DEBUG = 1 ]; then
    cp $REGRESSIONFILE $REGRESSIONFILE-$i-$j
    cp $LOGFILE $LOGFILE-$i-$j
    fi
   fi # No timeout
  echo -n "$RESULT;$TIME;"
  echo "<td>$RESULT</td><td>$TIME</td>" >> $MYDIR/$HTML
  done # All provers done for this tests
 echo
 echo "</tr>" >> $MYDIR/$HTML
 done # All tests done
echo "</table>" >> $MYDIR/$HTML
