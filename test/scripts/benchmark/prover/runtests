#!/bin/sh
# Creates a benchmark output for the prover in CSV format to stdout
# @author Zoltan Kovacs <zoltan@geogebra.org>

DEBUG=1
TIMEOUT=20
PROVERS="Botana Recio PureSymbolic"
LOGFILE=.test.log
REGRESSIONFILE=.regression.out
MYDIR=`dirname $0`
MYDIR_ABSOLUTE=`cd $MYDIR; pwd`

BUILDDIR=../../../../desktop/build
test -r $BUILDDIR/geogebra.jar || exit 1 # Non-existing JAR

# Heading
echo -n "Filename;"
for j in $PROVERS; do
 echo -n "$j result;Speed;"
 done
echo

# Content
for i in *.ggb; do
 echo -n "$i;"
 for j in $PROVERS; do
  cd $MYDIR_ABSOLUTE; cd $BUILDDIR
  timeout $TIMEOUT java -jar geogebra.jar --prover=engine:$j --logFile=$LOGFILE \
   --regressionFile=$REGRESSIONFILE $MYDIR_ABSOLUTE/$i --language=en \
   >.test.stdout 2>.test.stderr
  RETVAL=$?
  if [ $RETVAL = 124 ]; then
   echo -n ";timeout;"
  else
   # Regression out file shows the wrong result (the stored value in the file is shown):
   # RESULT=`cat $REGRESSIONFILE | grep Prove | sed 's/\(.*\) = \(.*\)/\2/'`
   RESULT=`cat $LOGFILE | grep "Statement is " | sed 's/\(.*\)Statement is \(.*\)/\2/'`
   TIME=`cat $LOGFILE | grep Benchmarking | awk '{print $5}'`
   if [ $DEBUG = 1 ]; then
    cp $REGRESSIONFILE $REGRESSIONFILE-$i-$j
    cp $LOGFILE $LOGFILE-$i-$j
    fi
   echo -n "$RESULT;$TIME;"
   fi # No timeout
  done # All provers done for this tests
 echo
 done # All tests done
