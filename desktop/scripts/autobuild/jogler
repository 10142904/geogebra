#!/bin/sh
# The JOGL juggler. Creates a mixture of build directory from JOGL1 and JOGL2 builds.

MYDIR=test50
CV=5.0
COMPILE=0
WWWDIR=/home/build/www-autobuild

ORIGDIR=`dirname $0`
cd $ORIGDIR
ORIGDIR=`pwd`

# 1/1. Start and loading configuration
test -r autobuild.conf || {
 echo "$0: Cannot find autobuild.conf (make sure you edit autobuild.conf.dist first)"
 exit 1
 }
test -r autobuild.conf && . ./autobuild.conf

# 1/2. Reading command line arguments
while [ $# -gt 0 ]; do
 case $1 in
  -h | -help | --help)
   echo "This script jogles GeoGebra 5 files."
   echo
   echo "Usage: $0 [options]"
   echo " Where options can be (defaults in parentheses):"
   echo "  -h, -help, --help         This help"
   echo "  -c                        Compile first (runs build-pack-installer)"
   echo "  -l [file]                 Logging to file (passed to build-pack-installer)"
   echo "  -u [url]                  Target URL (passed to build-pack-installer)"
   echo "  -t [dir]                  Target directory ($MYDIR)"
   echo "  -w [dir]                  Target directory root folder, path to target URL ($WWWDIR)"
   exit 0
   ;;

  -L)
   shift
   L="-l $1"
   ;;

  -u)
   shift
   TESTURL="$1"
   TU="-tu $TESTURL"
   ;;

  -t)
   shift
   MYDIR="$1"
   ;;

  -w)
   shift
   WWWDIR="$1"
   ;;

  -c)
   COMPILE=1
   ;;

  *)
   echo "Unknown parameter: $1. Use \"$0 -h\" for help."
   exit 32
   ;;

  esac
 shift
 done

# 2. Compilation
if [ $COMPILE = 1 ]; then
 for i in 1 2; do
  cd $ORIGDIR
  ./build-pack-installer -l /tmp/jogler.log $L $TU -cv 5.0 -J $i || exit $?
  cd ../..
  rm -fR build-jogl$i
  cp -a build build-jogl$i
  done
 fi

# 3. Copying files
cd $ORIGDIR/../..

copyover () {
JOGL=$1; FILENAME=$2; NEWNAME=$3
find build-jogl$JOGL -name $FILENAME | while read FILE; do
 DIR=`dirname $FILE`
 DIR2=`echo $DIR | sed s/build-jogl$JOGL//`
 COMMAND="cp $FILE $WWWDIR/$MYDIR/$DIR2/$NEWNAME"
 echo $COMMAND
 $COMMAND
 done
}

for i in jar jar.pack.gz; do
 copyover 1 geogebra.$i geogebra-jogl1.$i
 copyover 1 gluegen-rt.$i gluegen-rt-jogl1.$i
 copyover 1 geogebra_3d.$i geogebra_3d-jogl1.$i
 copyover 2 geogebra.$i geogebra-jogl2.$i
 copyover 2 geogebra_3d.$i geogebra_3d-jogl2.$i
 done

# 3/2. Copying over jogl.jar and jogl1-*.jar
find build-jogl1 -name jogl.jar -or -name 'jogl1-*' | while read FILE; do
 DIR=`dirname $FILE`
 DIR2=`echo $DIR | sed s/build-jogl1//`
 COMMAND="cp $FILE $WWWDIR/$MYDIR/$DIR2"
 echo $COMMAND
 $COMMAND
 done

# 4. Deleting unnecessary files
find $WWWDIR/$MYDIR -name geogebra.jar -or -name geogebra_3d.jar | xargs rm

# 5. Changing JNLP files
for i in . debug; do
 sed -i -e s/"geogebra\.jar"/geogebra-jogl1.jar/g \
  -e s/"geogebra_3d\.jar"/geogebra_3d-jogl1.jar/g \
  -e s/"gluegen-rt\.jar"/gluegen-rt-jogl1.jar/g \
  $WWWDIR/$MYDIR/$i/geogebra-50-jogl1.jnlp

 sed -i -e s/"geogebra\.jar"/geogebra-jogl2.jar/g \
  -e s/"geogebra_3d\.jar"/geogebra_3d-jogl2.jar/g \
  $WWWDIR/$MYDIR/$i/geogebra-50-jogl2.jnlp
  done

# 6. If there was no compilation (=typically deployment), there was no changing of the URL string, either.
# So we must do it now:
if [ "$COMPILE" = "0" ]; then
cd $WWWDIR/$MYDIR
TESTURLSED=`echo $TESTURL | sed s/"\/"/"\\\\\\\\\/"/g`
find . -name '*.jnlp' | while read i do
 cat $i | \
  sed s/"http:\/\/www.geogebra.org\/webstart\/$CV\/unsigned"/"$TESTURLSED\/$MYDIR\/unsigned\/unpacked"/g | \
  sed s/"http:\/\/www.geogebra.org\/webstart\/$CV\/debug"/"$TESTURLSED\/$MYDIR\/debug"/g | \
  sed s/"http:\/\/www.geogebra.org\/webstart\/$CV\/jnlp\/"/"$TESTURLSED\/$MYDIR\/unpacked\/"/g | \
  sed s/"http:\/\/www.geogebra.org\/webstart\/$CV\/"/"$TESTURLSED\/$MYDIR\/"/g | \
  sed s/"<\/title>"/" ($MYVER)<\/title>"/g | \
  grep -v "association mime-type" | \
  grep -v packEnabled | \
  sed s/"\$LONGVERSION"/"$MYVER"/g | \
   > $i.work
  mv $i.work $i || exit 6
 done
