#!/bin/sh
# Compiles GeoGebraWeb via command line.
# @author Zoltan Kovacs <zoltan@geogebra.org>
# Make sure that you run this script from its directory.

# 0. Functions first

# Cleanup
cleanup() {
 LASTEXITCODE=$?
 test -r $WEBDIR/src/geogebra/Web.gwt.xml.orig && {
  echo "Cleaning up: putting back original Web.gwt.xml"
  cd $WEBDIR/src/geogebra
  mv Web.gwt.xml.orig Web.gwt.xml
  }
 cd $WEBDIR/src/geogebra
 for i in *; do
  test -L $i && {
   echo "Clieaning up: removing link to $i"
   rm $i
   }
  done
  
 exit $LASTEXITCODE
}

# Lists the newest file according to the $1 pattern
l() {
 ls -1 -t $1 | tail -1
 }

# Sets the classpath. This must be fine tuned
# and maybe tidied up a bit, FIXME
classpath() {
CLASSPATH=\
$GGDIR/web/src:\
$GGDIR/common/src:\
$GGDIR/common/war/WEB-INF/lib:\
$GGDIR/common/src/geogebra/jre:\
$GGDIR/common/src/geogebra/webapache:\
/web/test-classes:\
$GGDIR/web/war/WEB-INF/classes:\
$GWTDIR/gwt-user.jar:\
$GWTDIR/gwt-dev.jar:\
`l $GWTDIR/validation-api-*.GA-sources.jar`:\
`l $GWTDIR/validation-api-*.GA.jar`:\
$GGDIR/common/test-classes:\
$GGDIR/common/war/WEB-INF/classes:\
`l $GAEDIR/lib/shared/jsp/repackaged-appengine-ant-*.jar`:\
`l $GAEDIR/lib/shared/jsp/repackaged-appengine-ant-launcher-*.jar`:\
`l $GAEDIR/lib/shared/jsp/repackaged-appengine-jasper-*.jar`:\
`l $GAEDIR/lib/shared/jsp/repackaged-appengine-jasper-el-*.jar`:\
`l $GAEDIR/lib/shared/jsp/repackaged-appengine-tomcat-juli-*.jar`:\
$GAEDIR/lib/shared/appengine-local-runtime-shared.jar:\
$GAEDIR/lib/shared/el-api.jar:\
$GAEDIR/lib/shared/jsp-api.jar:\
$GAEDIR/lib/shared/servlet-api.jar:\
`l $GAEDIR/lib/user/orm/datanucleus-appengine-*.final.jar`:\
`l $GAEDIR/lib/user/orm/datanucleus-core-*.jar`:\
`l $GAEDIR/lib/user/orm/datanucleus-jpa-*.jar`:\
`l $GAEDIR/lib/user/orm/geronimo-jpa_*_spec-*.jar`:\
`l $GAEDIR/lib/user/orm/geronimo-jta_*_spec-*.jar`:\
`l $GAEDIR/lib/user/orm/jdo2-api-*-eb.jar`:\
`l $GAEDIR/lib/user/appengine-api-*-sdk-*.jar`:\
`l $GAEDIR/lib/user/appengine-api-labs-*.jar`:\
`l $GAEDIR/lib/user/appengine-jsr*cache-*.jar`:\
`l $GAEDIR/lib/user/jsr*cache-*.jar`:\
$GAEDIR/lib/appengine-tools-api.jar:\
$GWTDIR/gwt-dev.jar

export CLASSPATH
}

# 1. Setting up environment variables

GWTDIR=../gwt-2.4.0 # Override it if needed by using autobuild.conf
XML=`which xml 2>/dev/null`
if [ "$XML" = "" ]; then
 XML=`pwd`/xml
 fi
GGDIR=`cd ..; pwd`

test -r autobuild.conf && . ./autobuild.conf && echo "Using autobuild.conf for overriding defaults"

# 2. Setting defaults
if [ "$SVNDIR" = "" ]; then
 ORIGDIR=`dirname $0`
 WORKDIR=`cd $ORIGDIR; pwd`
else
 WORKDIR=`cd $SVNDIR/geogebra/web; pwd`
 fi

export GWTDIR
cd $WORKDIR
WEBDIR=`pwd`

VERBOSE=0
USERAGENTS=gecko1_8,safari,ie9,opera
INSTALLDIR=""
XS=0
STYLE=OBFUSCATED
OTHEROPTS=""

trap "cleanup" EXIT 2 9 15

# 3. Reading command line arguments
while [ $# -gt 0 ]; do
 case $1 in
  -h | -help | --help)
   echo "This script builds and installs GeoGebraWeb."
   echo
   echo "Usage: $0 [options]"
   echo " Where options can be (defaults in parentheses):"
   echo "  -h, -help, --help   This help"
   echo "  -u [useragents]     Comma separated list of user agents to compile ($USERAGENTS)"
   echo "  -i [directory]      If set, installs GeoGebraWeb into the given directory"
   echo "  -x                  XS compilation"
   echo "  -s [style]          Compilation style: OBFUSCATED, PRETTY or DETAILED ($STYLE)"
   echo "  -g [directory]      Use GWT SDK from the given directory ($GWTDIR)"
   echo "  -gae [directory]    Use GAE SDK from the given directory ($GAEDIR)"
   echo "  -X [path]           Use XMLStarlet from the given path ($XML)"
   echo "  -v, --verbose       Be verbose whenever possible"
   echo "  -- [options]        Forward the rest options directly to the GWT Compiler"
   echo "  -H                  Show extra options for the GWT Compiler"
   echo
   echo "Example: ./build -X /usr/local/bin/xml -s PRETTY -u safari -i /tmp/ggw -- -draftCompile"
   exit 0
   ;;

  -u)
   shift
   USERAGENTS="$1"
   ;;

  -i)
   shift
   INSTALLDIR="$1"
   ;;

  -X)
   shift
   XML="$1"
   ;;

  -x)
   XS=1
   ;;

  -s)
   shift
   STYLE="$1"
   ;;
   
  -g)
   shift
   GWTDIR="$1"
   ;;

  -gae)
   shift
   GAEDIR="$1"
   ;;

  -v | --verbose)
   VERBOSE=1
   ;;
   
  --)
   shift
   OTHEROPTS=$*
   while [ "$2" != "" ]; do
    shift
    done
   ;;
   
  -H)
   classpath
   java com.google.gwt.dev.Compiler
   exit 0
   ;;

  *)
   echo "Unknown parameter: $1. Use \"$0 -h\" for help."
   exit 1
   ;;

  esac
 shift
 done

if [ "$VERBOSE" = 1 ]; then
 ANT="ant -v"
else
 ANT="ant"
 fi

# 4. Testing configuration
test -d $GWTDIR || {
 echo "No GWT SDK directory exists at $GWTDIR"
 exit 4
}
test -d $GAEDIR || {
 echo "No GAE SDK directory exists at $GAEDIR"
 exit 4
 }
test -x $XML || {
 echo "No XMLStarlet executable exists at $XML"
 exit 4
 }

echo "GWT SDK directory is set to $GWTDIR"
echo "GAE SDK directory is set to $GAEDIR"
echo "User agents: $USERAGENTS"
echo "Compilation style: $STYLE"
echo

# 5. (Re)creating parser
cd ../desktop
$ANT compile-grammar-cl || exit 5

# 6. Compiling web with javac
cd ../web/src/geogebra
ln -s ../../../common/src/com
ln -s ../../../common/src/geogebra/common
ln -s ../../../common/src/geogebra/webapache

cd $WEBDIR
$ANT javac || exit 6

# 7. Preparing specific compilation
cd ../web/src/geogebra
GWTXML=Web.gwt.xml
cp $GWTXML $GWTXML.orig

cat $GWTXML | \
 $XML ed -u "/module/set-property[@name='user.agent']/@value" -v "$USERAGENTS" > $GWTXML-b

if [ "$XS" = "1" ]; then
 cat $GWTXML-b | \
  $XML ed -d /module/add-linker |\
  $XML ed -s /module -t elem -n "add-linker" -v "" |\
  $XML ed -i /module/add-linker -t attr -n name -v xs > $GWTXML-b2
 mv $GWTXML-b2 $GWTXML-b
 fi

mv $GWTXML-b $GWTXML

# 8. Compiling web with GWT Compiler
classpath
java -Xmx512m com.google.gwt.dev.Compiler\
 -style $STYLE -war $GGDIR/web/war -strict $OTHEROPTS geogebra.Web || exit 8

# 9. Done!
if [ "$INSTALLDIR" = "" ]; then
 echo "GeoGebraWeb compilation finished. Insert this URL into your browser to test it:"
 echo "file:///$WEBDIR/war/Web.html"
else
 echo "Trying to (re)create $INSTALLDIR..."
 mkdir -p $INSTALLDIR || exit 9
 cp -a $WEBDIR/war/* $INSTALLDIR
 for i in .svn WEB-INF; do
  rm -fR $INSTALLDIR/$i
  done
 echo "GeoGebraWeb compilation finished. Insert this URL into your browser to test it:"
 echo "file:///$INSTALLDIR/Web.html"
 fi

exit 0
