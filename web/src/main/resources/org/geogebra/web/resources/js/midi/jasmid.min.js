function MidiFile(e){function t(e){var t=e.read(4),r=e.readInt32();return{id:t,length:r,data:e.read(r)}}function r(e){var t={};t.deltaTime=e.readVarInt();var r=e.readInt8();if(240==(240&r)){if(255==r){t.type="meta";var a=e.readInt8(),u=e.readVarInt();switch(a){case 0:if(t.subtype="sequenceNumber",2!=u)throw"Expected length for sequenceNumber event is 2, got "+u;return t.number=e.readInt16(),t;case 1:return t.subtype="text",t.text=e.read(u),t;case 2:return t.subtype="copyrightNotice",t.text=e.read(u),t;case 3:return t.subtype="trackName",t.text=e.read(u),t;case 4:return t.subtype="instrumentName",t.text=e.read(u),t;case 5:return t.subtype="lyrics",t.text=e.read(u),t;case 6:return t.subtype="marker",t.text=e.read(u),t;case 7:return t.subtype="cuePoint",t.text=e.read(u),t;case 32:if(t.subtype="midiChannelPrefix",1!=u)throw"Expected length for midiChannelPrefix event is 1, got "+u;return t.channel=e.readInt8(),t;case 47:if(t.subtype="endOfTrack",0!=u)throw"Expected length for endOfTrack event is 0, got "+u;return t;case 81:if(t.subtype="setTempo",3!=u)throw"Expected length for setTempo event is 3, got "+u;return t.microsecondsPerBeat=(e.readInt8()<<16)+(e.readInt8()<<8)+e.readInt8(),t;case 84:if(t.subtype="smpteOffset",5!=u)throw"Expected length for smpteOffset event is 5, got "+u;var o=e.readInt8();return t.frameRate={0:24,32:25,64:29,96:30}[96&o],t.hour=31&o,t.min=e.readInt8(),t.sec=e.readInt8(),t.frame=e.readInt8(),t.subframe=e.readInt8(),t;case 88:if(t.subtype="timeSignature",4!=u)throw"Expected length for timeSignature event is 4, got "+u;return t.numerator=e.readInt8(),t.denominator=Math.pow(2,e.readInt8()),t.metronome=e.readInt8(),t.thirtyseconds=e.readInt8(),t;case 89:if(t.subtype="keySignature",2!=u)throw"Expected length for keySignature event is 2, got "+u;return t.key=e.readInt8(!0),t.scale=e.readInt8(),t;case 127:return t.subtype="sequencerSpecific",t.data=e.read(u),t;default:return t.subtype="unknown",t.data=e.read(u),t}return t.data=e.read(u),t}if(240==r){t.type="sysEx";var u=e.readVarInt();return t.data=e.read(u),t}if(247==r){t.type="dividedSysEx";var u=e.readVarInt();return t.data=e.read(u),t}throw"Unrecognised MIDI event type byte: "+r}var c;0==(128&r)?(c=r,r=n):(c=e.readInt8(),n=r);var s=r>>4;switch(t.channel=15&r,t.type="channel",s){case 8:return t.subtype="noteOff",t.noteNumber=c,t.velocity=e.readInt8(),t;case 9:return t.noteNumber=c,t.velocity=e.readInt8(),t.subtype=0==t.velocity?"noteOff":"noteOn",t;case 10:return t.subtype="noteAftertouch",t.noteNumber=c,t.amount=e.readInt8(),t;case 11:return t.subtype="controller",t.controllerType=c,t.value=e.readInt8(),t;case 12:return t.subtype="programChange",t.programNumber=c,t;case 13:return t.subtype="channelAftertouch",t.amount=c,t;case 14:return t.subtype="pitchBend",t.value=c+(e.readInt8()<<7),t;default:throw"Unrecognised MIDI event type: "+s}}var n;stream=Stream(e);var a=t(stream);if("MThd"!=a.id||6!=a.length)throw"Bad .mid file - header not found";var u=Stream(a.data),o=u.readInt16(),c=u.readInt16(),s=u.readInt16();if(32768&s)throw"Expressing time division in SMTPE frames is not supported yet";ticksPerBeat=s;for(var d={formatType:o,trackCount:c,ticksPerBeat:ticksPerBeat},i=[],f=0;d.trackCount>f;f++){i[f]=[];var v=t(stream);if("MTrk"!=v.id)throw"Unexpected chunk - expected MTrk, got "+v.id;for(var l=Stream(v.data);!l.eof();){var p=r(l);i[f].push(p)}}return{header:d,tracks:i}}function Replayer(e,t,r,n){function a(){for(var t=null,r=null,n=null,a=0;o.length>a;a++)null!=o[a].ticksToNextEvent&&(null==t||t>o[a].ticksToNextEvent)&&(t=o[a].ticksToNextEvent,r=a,n=o[a].nextEventIndex);if(null!=r){var u=e.tracks[r][n];e.tracks[r][n+1]?o[r].ticksToNextEvent+=e.tracks[r][n+1].deltaTime:o[r].ticksToNextEvent=null,o[r].nextEventIndex+=1;for(var a=0;o.length>a;a++)null!=o[a].ticksToNextEvent&&(o[a].ticksToNextEvent-=t);return{ticksToEvent:t,event:u,track:r}}return null}function u(){function e(){s||"meta"!=f.event.type||"setTempo"!=f.event.subtype||(c=6e7/f.event.microsecondsPerBeat);var e=0,r=0;f.ticksToEvent>0&&(e=f.ticksToEvent/d,r=e/(c/60));var n=1e3*r*t||0;v.push([f,n]),f=a()}if(f=a())for(;f;)e(!0)}for(var o=[],c=n?n:120,s=n?!0:!1,d=e.header.ticksPerBeat,i=0;e.tracks.length>i;i++)o[i]={nextEventIndex:0,ticksToNextEvent:e.tracks[i].length?e.tracks[i][0].deltaTime:null};var f,v=[];return u(),{getData:function(){return clone(v)}}}function Stream(e){function t(t){var r=e.substr(c,t);return c+=t,r}function r(){var t=(e.charCodeAt(c)<<24)+(e.charCodeAt(c+1)<<16)+(e.charCodeAt(c+2)<<8)+e.charCodeAt(c+3);return c+=4,t}function n(){var t=(e.charCodeAt(c)<<8)+e.charCodeAt(c+1);return c+=2,t}function a(t){var r=e.charCodeAt(c);return t&&r>127&&(r-=256),c+=1,r}function u(){return c>=e.length}function o(){for(var e=0;;){var t=a();if(!(128&t))return e+t;e+=127&t,e<<=7}}var c=0;return{eof:u,read:t,readInt32:r,readInt16:n,readInt8:a,readVarInt:o}}var clone=function(e){if("object"!=typeof e)return e;if(null==e)return e;var t="number"==typeof e.length?[]:{};for(var r in e)t[r]=clone(e[r]);return t};