!function(t){var e={};function n(s){if(e[s])return e[s].exports;var i=e[s]={i:s,l:!1,exports:{}};return t[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=9)}([function(t,e,n){"use strict";function s(t,n){return Object.keys(e.defaultFormatting).every(e=>t[e]===n[e])}function i(t){const n={text:t.text};return Object.keys(e.defaultFormatting).forEach(s=>{const i=t[s];i&&i!=e.defaultFormatting[s]&&(n[s]=i)}),n}function r(t){return t.length||1}function o(t){return t.length?t:"_"}function*l(t,e,n){if(0!==n)if("string"!=typeof t)if(Array.isArray(t)){let s=0;for(const i of t){if(n<=0)break;const t=r(i);if(s+t>e)if(1===t)yield i,n-=1;else{const t=i.substr(Math.max(0,e-s),n);yield t,n-=t.length}s+=t}}else yield t;else yield t.substr(e,n)}Object.defineProperty(e,"__esModule",{value:!0}),e.defaultFormatting={size:16,font:"sans-serif",color:"black",bgcolor:"transparent",bold:!1,italic:!1,underline:!1,strikeout:!1,align:"left",script:"normal"},e.multipleValues={},e.sameFormatting=s,e.clone=i,e.merge=function(t,n){const s={};return Object.keys(e.defaultFormatting).forEach(i=>{(i in t||i in n)&&(t[i]===n[i]?s[i]=t[i]:s[i]=e.multipleValues)}),s},e.format=function t(n,s){Array.isArray(n)?n.forEach(e=>{t(e,s)}):Object.keys(s).forEach(t=>{s[t]!==e.multipleValues&&(n[t]=s[t])})},e.consolidate=function*(t){let e;for(const n of t)e&&s(e,n)&&"string"==typeof e.text&&"string"==typeof n.text?e.text+=n.text:(e=i(n),yield e)},e.getPlainText=function(t){if("string"==typeof t.text)return t.text;if(Array.isArray(t.text)){const e=[];return t.text.forEach(t=>{e.push(o(t))}),e.join("")}return"_"},e.getPieceLength=r,e.getPiecePlainText=o,e.getTextLength=function(t){if("string"==typeof t)return t.length;if(Array.isArray(t)){let e=0;return t.forEach(t=>{e+=r(t)}),e}return 1},e.getSubText=l,e.getTextChar=function(t,e){return l(t,e,1).next().value},e.pieceCharacters=function(t,e){if("string"==typeof e)for(let n=0;n<e.length;n++)t(e[n]);else t(e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class s{constructor(t,e,n,s){this.l=t,this.t=e,this.w=n,this.h=s,this.w=n,this.h=s,this.r=t+n,this.b=e+s}contains(t,e){return t>=this.l&&t<this.r&&e>=this.t&&e<this.b}stroke(t){t.strokeRect(this.l,this.t,this.w,this.h)}fill(t){t.fillRect(this.l,this.t,this.w,this.h)}offset(t,e){return new s(this.l+t,this.t+e,this.w,this.h)}equals(t){return this.l===t.l&&this.t===t.t&&this.w===t.w&&this.h===t.h}center(){return{x:this.l+this.w/2,y:this.t+this.h/2}}}e.default=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.event=function(){const t=[],e=function(e){t.push(e)};return e.fire=(...e)=>{t.forEach(t=>{t(...e)})},e},e.derive=function(t,e){const n={};return Object.keys(e).forEach(t=>{n[t]={value:e[t]}}),Object.create(t,n)},e.gmap=function*(t,e){for(const n of t)yield e(n)},e.gfoldl=function(t,e){let n=t.next().value;for(const s of t)n=e(n,s);return n},e.gfilter=function*(t,e){for(const n of t)e(n)&&(yield n)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(1);class i{constructor(t){this.type=t}children(){return[]}parent(){return null}first(){return this.children()[0]}last(){return this.children()[this.children().length-1]}next(){let t=this;for(;;){const e=t.parent();if(!e)return null;const n=e.children();let s=n[n.indexOf(t)+1];if(s){for(;;){const t=s.first();if(!t)break;s=t}return s}t=e}}previous(){const t=this.parent();if(!t)return null;const e=t.children(),n=e[e.indexOf(this)-1];if(n)return n;const s=t.previous();return s?s.last():null}byOrdinal(t){let e=null;return this.children().some(n=>{if(t>=n.ordinal&&t<n.ordinal+n.length&&(e=n.byOrdinal(t)))return!0})?e:this}byCoordinate(t,e){for(const n of this.children()){if(n.bounds().contains(t,e)){let s=n.byCoordinate(t,e);if(s)return s}}let n=this.last();for(;n;){const t=n.last();if(!t)break;n=t}const s=n.next();return s&&s.block&&(n=s),n}draw(t,e){this.children().forEach(n=>{n.draw(t,e)})}parentOfType(t){const e=this.parent();return e&&(e.type===t?e:e.parentOfType(t))}bounds(){let t=this._left,e=this._top,n=0,i=0;return this.children().forEach(s=>{const r=s.bounds();t=Math.min(t,r.l),e=Math.min(e,r.t),n=Math.max(n,r.l+r.w),i=Math.max(i,r.t+r.h)}),new s.default(t,e,n-t,i-e)}}e.Node=i;e.GenericNode=class extends i{constructor(t,e,n,s){super(t),this._children=[],this._parent=e,this._left="number"==typeof n?n:Number.MAX_VALUE,this._top="number"==typeof s?s:Number.MAX_VALUE}children(){return this._children}parent(){return this._parent}finalize(t,e){let n=Number.MAX_VALUE,s=0;this._children.forEach(t=>{n=Math.min(n,t.ordinal),s=Math.max(s,t.ordinal+t.length)}),this.ordinal=n-(t||0),this.length=(e||0)+s-n}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(0);function i(t){let e=t&&t.size||s.defaultFormatting.size;if(t)switch(t.script){case"super":case"sub":e*=.8}return(t&&t.italic?"italic ":"")+(t&&t.bold?"bold ":"")+" "+e+"px "+(t&&t.font||s.defaultFormatting.font)}function r(t,e){t.fillStyle=e&&e.bgcolor||s.defaultFormatting.bgcolor}function o(t,e){t.fillStyle=e&&e.color||s.defaultFormatting.color,t.font=i(e)}function l(t){t.textAlign="left",t.textBaseline="alphabetic"}function a(t){const e=["font: ",i(t),"; color: ",t&&t.color||s.defaultFormatting.color];if(t)switch(t.script){case"super":e.push("; vertical-align: super");break;case"sub":e.push("; vertical-align: sub")}return e.join("")}e.getFontString=i,e.applyRunBackgroundStyle=r,e.applyRunStyle=o,e.prepareContext=l,e.getRunStyle=a,e.nbsp=String.fromCharCode(160),e.enter=String.fromCharCode(160);class c{constructor(t,e,n){this.width=t,this.ascent=e,this.descent=n,this.height=e+n}}function h(t,n,s){const r=document.createElement("canvas").getContext("2d");r.font=i(n);const o=r.measureText(t);if(o.actualBoundingBoxAscent&&o.actualBoundingBoxDescent)return new c(o.width,o.actualBoundingBoxAscent,o.actualBoundingBoxDescent);const l=document.createElement("span"),a=document.createElement("div"),h=document.createElement("div");a.style.display="inline-block",a.style.width="1px",a.style.height="0",h.style.visibility="hidden",h.style.position="absolute",h.style.top="0",h.style.left="0",h.style.width="2000px",h.style.height="200px",h.appendChild(l),h.appendChild(a),document.body.appendChild(h);try{l.setAttribute("style",s),l.innerHTML="",l.appendChild(document.createTextNode(t.replace(/\s/g,e.nbsp))),a.style.verticalAlign="baseline";const n=a.offsetTop-l.offsetTop;return a.style.verticalAlign="bottom",new c(o&&o.width||l.offsetWidth,n,a.offsetTop-l.offsetTop-n)}finally{h.parentNode.removeChild(h)}}e.Measure=c,e.measureText=h;const d=(()=>{const t=new Map;return function(e,n){const s=a(n),i=s+"<>!&%"+e;let r=t.get(i);return r||(r=h(e,n,s),t.set(i,r)),r}})();e.measure=function(t,e){return d(t,e)},e.draw=function(t,n,s,i,a,c,h,d){switch(l(t),s.script){case"super":a-=h*(1/3);break;case"sub":a+=d/2}s.bgcolor&&(r(t,s),t.fillRect(i,a-h,c,h+d)),o(t,s),t.fillText("\n"===n?e.nbsp:n,i,a),s.underline&&t.fillRect(i,1+a,c,1),s.strikeout&&t.fillRect(i,1+a-h/2,c,1)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(4),i=n(4);class r{measure(t){const e=s.measure("?",t);return new i.Measure(e.width+4,e.width+2,e.width+2)}draw(t,e,n,s,i,r){t.fillStyle="silver",t.fillRect(e,n-i,s,i+r),t.strokeRect(e,n-i,s,i+r),t.fillStyle="black",t.fillText("?",e+2,n)}}class o{constructor(t,e,n,s){this.run=t,this.isNewLine=e,this.isNewLine=e,this.width=e?0:n.width,this.ascent=n.ascent,this.descent=n.descent,this.code=s}draw(t,e,n){"string"==typeof this.run.text?s.draw(t,this.run.text,this.run,e,n,this.width,this.ascent,this.descent):this.code&&this.code.draw&&(t.save(),this.code.draw(t,e,n,this.width,this.ascent,this.descent,this.run),t.restore())}}e.Part=o,e.part=function(t,e){let n,l,a;return"string"==typeof t.text?(l=1===t.text.length&&"\n"===t.text[0],n=s.measure(l?s.nbsp:t.text,t)):n=(a=e(t.text)||new r).measure?a.measure(t):new i.Measure(0,0,0),new o(t,l,n,a)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(5),i=n(0),r=n(2);class o{constructor(t,e,n){this.text=t,this.space=e,this.eof=n,this.ascent=Math.max(t.ascent,e.ascent),this.descent=Math.max(t.descent,e.descent),this.width=t.width+e.width,this.length=t.length+e.length}isNewLine(){return 1===this.text.parts.length&&this.text.parts[0].isNewLine}code(){return 1===this.text.parts.length&&this.text.parts[0].code}codeFormatting(){return 1===this.text.parts.length&&this.text.parts[0].run}draw(t,e,n){const s=s=>{s.draw(t,e,n),e+=s.width};this.text.parts.forEach(s),this.space.parts.forEach(s)}plainText(){return this.text.plainText+this.space.plainText}align(){const t=this.text.parts[0];return t?t.run.align:"left"}*runs(t){let e=t&&t.start||0,n=t&&t.end;"number"!=typeof n&&(n=Number.MAX_VALUE);for(const t of[this.text,this.space])for(const s of t.parts){if(e>=n||n<=0)return!0;const t=s.run,i=t.text;if("string"==typeof i){if(e<=0&&n>=i.length)yield t;else if(e<i.length){const s=Object.create(t),r=Math.max(0,e);s.text=i.substr(r,Math.min(i.length,n-r)),yield s}e-=i.length,n-=i.length}else e<=0&&n>=1&&(yield t),e--,n--}}}e.Word=o;class l{constructor(t){this.parts=t,this.ascent=0,this.descent=0,this.width=0,this.length=0,this.plainText="",this.parts.forEach(t=>{this.ascent=Math.max(this.ascent,t.ascent),this.descent=Math.max(this.descent,t.descent),this.width+=t.width,this.length+=i.getPieceLength(t.run.text),this.plainText+=i.getPiecePlainText(t.run.text)})}}e.Section=l,e.word=function(t,e){let n,i;return t?(n=new l([...r.gmap(t.text.cut(t.spaces),t=>s.part(t,e))]),i=new l([...r.gmap(t.spaces.cut(t.end),t=>s.part(t,e))])):(n=new l([s.part({text:"\n"},e)]),i=new l([])),new o(n,i,!t)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(3),i=n(1),r=n(15);class o extends s.Node{constructor(t,e,n){super("frame"),this.lines=t,this._parent=e,this.ordinal=n}bounds(){if(!this._bounds){let t=0,e=0,n=0,s=0;if(this.lines.length){const i=this.lines[0].bounds();t=i.l,e=i.t,this.lines.forEach(t=>{const e=t.bounds();n=Math.max(n,e.l+e.w),s=Math.max(s,e.t+e.h)})}this._bounds=new i.default(t,e,n-t,this.height||s-e)}return this._bounds}actualWidth(){if(!this._actualWidth){let t=0;this.lines.forEach(e=>{"number"==typeof e.actualWidth&&(t=Math.max(t,e.actualWidth))}),this._actualWidth=t}return this._actualWidth}children(){return this.lines}parent(){return this._parent}draw(t,e){const n=e?e.t:0,s=e?e.t+e.h:Number.MAX_VALUE;this.lines.some(i=>{const r=i.bounds();return!(r.t+r.h<n)&&(r.t>s||void i.draw(t,e))})}}e.Frame=o,e.frame=function(t,e,n,s,i,l,a,c,h){const d=[],u=new o(d,l,i),f=r.default(t,e,n,s,i,u,a,c,h);for(const t of f)"number"==typeof t?u.height=t:(u.length=t.ordinal+t.length-i,d.push(t));return u}},function(t,e,n){"use strict";function s(t){for(;t.firstChild;)t.removeChild(t.firstChild)}Object.defineProperty(e,"__esModule",{value:!0}),e.isAttached=function(t){let e=t;for(;e.parentNode;)e=e.parentNode;return!!e.body},e.clear=s,e.setText=function(t,e){s(t),t.appendChild(document.createTextNode(e))},e.handleEvent=function(t,e,n){t.addEventListener(e,t=>{!1===n(t)&&t.preventDefault()})},e.handleMouseEvent=function(t,e,n){t.addEventListener(e,e=>{const s=t.getBoundingClientRect();n(e,e.clientX-s.left,e.clientY-s.top),e.preventDefault()})}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(10),i=n(8),r=n(0),o=n(19);if(e.bundle={editor:s,dom:i,runs:r,html:o},"undefined"!=typeof window&&window.document){if(window.carota)throw new Error("Something else is called carota!");window.carota=e.bundle}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(11),i=n(8),r=n(1);setInterval(()=>{const t=document.querySelectorAll(".carotaEditorCanvas"),e=document.createEvent("Event");e.initEvent("carotaEditorSharedTimer",!0,!0);for(let n=0;n<t.length;n++)t[n].dispatchEvent(e)},200),e.create=function(t){t.innerHTML='<div class="carotaSpacer"><canvas width="100" height="100" class="carotaEditorCanvas" style="position: absolute;"></canvas></div><div class="carotaTextArea" style="overflow: hidden; position: absolute; height: 0;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; padding: 0; width: 1000px; height: 1em; outline: none; font-size: 4px;"></textarea>';const e=t.querySelector("canvas"),n=t.querySelector(".carotaSpacer"),o=t.querySelector(".carotaTextArea"),l=t.querySelector("textarea"),a=new s.CarotaDocument;let c,h=0,d=null,u=null,f=null,g=null,p="",w=null;const m=(new Map).set(66,"bold").set(73,"italic").set(85,"underline").set(83,"strikeout"),b=function(t,e){return e<0?t<=0:t>=a.frame.length-1},y=function(t,e){return t.b<=e.t||e.b<=t.t},x=function(t,e){let n,s=a.getCaretCoords(t);for(u=null!==d?d:s.l;!b(t,e)&&(t+=e,n=a.getCaretCoords(t),!y(n,s)););for(s=n;!b(t,e)&&!(e>0&&n.l>=u||e<0&&n.l<=u);)if(t+=e,n=a.getCaretCoords(t),y(n,s)){t-=e;break}return t},_=function(t,e){const n=a.getCaretCoords(t);let s;for(;!b(t,e);)if(t+=e,s=a.getCaretCoords(t),y(s,n)){t-=e;break}return t};i.handleEvent(l,"keydown",t=>{if(function(t,e,n){let s=a.selection.start,i=a.selection.end;const r=a.frame.length-1;let o=!1;if(u=null,e){if(!h)switch(t){case 37:case 38:case 36:case 33:h=-1;break;case 39:case 40:case 35:case 34:h=1}}else h=0;let l=1===h?i:s,f=!1;switch(t){case 37:if(e||s===i){if(l>0)if(n){const t=a.wordContainingOrdinal(l);l=t.ordinal===l?t.index>0?a.wordOrdinal(t.index-1):0:t.ordinal}else l--}else l=s;f=!0;break;case 39:if(e||s===i){if(l<r)if(n){const t=a.wordContainingOrdinal(l);l=t.ordinal+t.word.length}else l++}else l=i;f=!0;break;case 40:l=x(l,1),f=!0;break;case 38:l=x(l,-1),f=!0;break;case 36:l=_(l,-1),f=!0;break;case 35:l=_(l,1),f=!0;break;case 33:l=0,f=!0;break;case 34:l=r,f=!0;break;case 8:s===i&&s>0&&(a.range(s-1,s).clear(),g=s-1,a.select(g,g),o=!0);break;case 46:s===i&&s<r&&(a.range(s,s+1).clear(),o=!0);break;case 90:n&&(o=!0,a.performUndo());break;case 89:n&&(o=!0,a.performUndo(!0));break;case 65:n&&(o=!0,a.select(0,r));break;case 67:case 88:n&&(c=a.selectedRange().save(),w=a.selectedRange().plainText())}const p=m.get(t);if(n&&p){const t=a.selectedRange();t.setFormatting(p,!0!==t.getFormatting()[p]),k(),o=!0}if(f){switch(h){case 0:s=i=l;break;case-1:s=l;break;case 1:i=l}if(s===i)h=0;else if(s>i){h=-h;const t=i;i=s,s=t}g=l,a.select(s,i),o=!0}return d=u,o}(t.keyCode,t.shiftKey,t.ctrlKey))return!1});let v="top",C="transparent";a.setVerticalAlignment=function(t){v=t,k()},a.setBackgroundColor=function(t){C=t,k()};const O=()=>{const e=a.frame.bounds().h;if(e<t.clientHeight)switch(v){case"middle":return(t.clientHeight-e)/2;case"bottom":return t.clientHeight-e}return 0},k=()=>{const s=1*t.clientWidth;a.width()!==s&&a.setWidth(s);const i=a.frame.bounds().h,o=Math.max(1,window.devicePixelRatio||1),c=Math.max(a.frame.actualWidth(),t.clientWidth),h=t.clientHeight;e.width=o*c,e.height=o*h,e.style.width=c+"px",e.style.height=h+"px",e.style.top=t.scrollTop+"px",n.style.width=c+"px",n.style.height=Math.max(i,t.clientHeight)+"px",i<t.clientHeight-50&&a.frame.actualWidth()<=s?t.style.overflow="hidden":t.style.overflow="auto";const d=e.getContext("2d");d.scale(o,o),d.fillStyle=C,d.fillRect(0,0,c,h),d.translate(0,O()-t.scrollTop),a.draw(d,new r.default(0,t.scrollTop,c,h)),a.drawSelection(d,!!f||document.activeElement===l)};t.addEventListener("scroll",k),l.addEventListener("input",()=>{let t=l.value;p!==t&&(p="",l.value="",t===w&&(t=c),a.insert(t))});const M=()=>{g=null===g?a.selection.end:g;const e=a.byOrdinal(g);if(g=null,e){const n=e.bounds();o.style.left=n.l+"px",o.style.top=n.t+"px",l.focus();const s=Math.max(0,n.t+n.h-(t.scrollTop+t.clientHeight));s&&(t.scrollTop+=s);const i=Math.max(0,t.scrollTop-n.t);i&&(t.scrollTop-=i);const r=Math.max(0,n.l-(t.scrollLeft+t.clientWidth));r&&(t.scrollLeft+=r);const a=Math.max(0,t.scrollLeft-n.l);a&&(t.scrollLeft-=a)}p=a.selectedRange().plainText(),l.value=p,l.select(),setTimeout(()=>{l.focus()},10)};a.selectionChanged((t,e)=>{k(),f||!1!==e&&M()});const E=(t,e)=>{i.handleMouseEvent(n,t,(t,n,s)=>{e(a.byCoordinate(n,s-O()))})};E("mousedown",t=>{f=t.ordinal,a.select(t.ordinal,t.ordinal),d=null}),E("dblclick",t=>{(t=t.parent())&&a.select(t.ordinal,t.ordinal+(t.word?t.word.text.length:t.length))}),E("mousemove",t=>{null!==f&&t&&(g=t.ordinal,f>t.ordinal?a.select(t.ordinal,f):a.select(f,t.ordinal))}),E("mouseup",t=>{f=null,d=null,M(),l.focus()});let T=(new Date).getTime(),S=!1,j=t.clientWidth,N=t.clientHeight;const R=function(){let e=!1;const n=document.activeElement===l;S!==n&&(S=n,e=!0);const s=(new Date).getTime();s>T&&(T=s+500,a.toggleCaret()&&(e=!0)),t.clientWidth===j&&t.clientHeight===N||(e=!0,j=t.clientWidth,N=t.clientHeight),e&&k()};return e.addEventListener("carotaEditorSharedTimer",R),R(),a}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(12),i=n(13),r=n(6),o=n(3),l=n(0),a=n(14),c=n(2),h=n(7),d=n(18),u=n(1),f=n(2),g=(t,e,n,s)=>{const i=t.selection.start,r=t.selection.end;return function(o){t._wordOrdinals=[];const l=Array.prototype.splice.apply(t.words,[e,n].concat(s));o(g(t,e,s.length,l)),t._nextSelection={start:i,end:r}}},p=t=>{const e=[];return t(t=>{e.push(t),this.length=e.length}),t=>{t(p(t=>{for(;e.length;)e.pop()(t)}))}},w=t=>{if(t.isNewLine())return!0;const e=t.code();return!(!e||!e.block&&!e.eof)};class m extends o.Node{constructor(){super("document"),this._width=0,this.selection={start:0,end:0},this.caretVisible=!0,this.selectionChanged=c.event(),this.contentChanged=c.event(),this.editFilters=[d.editFilter],this.load([])}load(t,e){this.undo=[],this.redo=[],this._wordOrdinals=[],this.words=[],this.words=[...f.gmap(i.split(this.codes.bind(this),s.characters(t)),t=>r.word(t,this.codes.bind(this)))],this.layout(),this.contentChanged.fire(),this.select(0,0,e)}layout(){this.frame=null;try{this.frame=h.frame(this.words,0,0,this._width,0,this)}catch(t){console.error(t)}if(this.frame){if(this._nextSelection){const t=this._nextSelection;delete this._nextSelection,this.select(t.start,t.end,!1)}}else console.error("A bug somewhere has produced an invalid state - rolling back"),this.performUndo()}customCodes(t,e,n){}codes(t,e){return d.codes(t,e,this.codes)||this.customCodes(t,e,this.codes)}range(t,e){return new a.Range(this,t,e)}documentRange(){return this.range(0,this.frame.length-1)}selectedRange(){return this.range(this.selection.start,this.selection.end)}save(){return this.documentRange().save()}paragraphRange(t,e){let n;const s=this.wordContainingOrdinal(t);if(t=0,s&&!w(s.word))for(n=s.index;n>0;n--)if(w(this.words[n-1])){t=this.wordOrdinal(n);break}const i=this.wordContainingOrdinal(e);if(e=this.frame.length-1,i&&!w(i.word))for(n=i.index;n<this.words.length;n++)if(w(this.words[n])){e=this.wordOrdinal(n);break}return this.range(t,e)}insert(t,e){this.select(this.selection.end+this.selectedRange().setText(t),null,e)}modifyInsertFormatting(t,e){this.nextInsertFormatting[t]=e,this.notifySelectionChanged(!1)}applyInsertFormatting(t){const e=this.nextInsertFormatting,n=Object.keys(e);n.length&&t.forEach(t=>{n.forEach(n=>{t[n]=e[n]})})}wordOrdinal(t){if(t<this.words.length){const e=this._wordOrdinals.length;if(e<t+1){let n=e>0?this._wordOrdinals[e-1]:0;for(let s=e;s<=t;s++)this._wordOrdinals[s]=n,n+=this.words[s].length}return this._wordOrdinals[t]}}wordContainingOrdinal(t){let e=0;for(let n=0;n<this.words.length;n++){const s=this.words[n];if(t>=e&&t<e+s.length)return{word:s,ordinal:e,index:n,offset:t-e};e+=s.length}}*runs(t){const e=this.wordContainingOrdinal(Math.max(0,t.start)),n=this.wordContainingOrdinal(Math.min(t.end,this.frame.length-1));if(e.index===n.index)yield*e.word.runs({start:e.offset,end:n.offset});else{yield*e.word.runs({start:e.offset});for(let t=e.index+1;t<n.index;t++)yield*this.words[t].runs();yield*n.word.runs({end:n.offset})}}spliceWordsWithRuns(t,e,n){const o=this,l=[...f.gmap(f.gfilter(i.split(this.codes.bind(this),s.characters(n)),t=>!!t),t=>r.word(t,this.codes.bind(this)))];let a=!1;if("_filtersRunning"in o)o._filtersRunning++;else{for(let n=0;n<e;n++)this.words[t+n].code()&&(a=!0);a||(a=l.some(t=>!!t.code()))}this.transaction(n=>{if(g(o,t,e,l)(n),a){o._filtersRunning=0;try{for(;;){const t=o._filtersRunning;if(!o.editFilters.some(e=>(e(o),t!==o._filtersRunning)))break}}finally{delete o._filtersRunning}}})}splice(t,e,n){if("string"==typeof n){const e=Math.max(0,t-1),s=this.runs({start:e,end:e+1}).next().value;n=[s?Object.create(s,{text:{value:n}}):{text:n}]}else Array.isArray(n)||(n=[{text:n}]);this.applyInsertFormatting(n);const s=this.wordContainingOrdinal(t),i=this.wordContainingOrdinal(e);let r,o;if(t===s.ordinal)if(s.index>0&&!w(this.words[s.index-1])){s.index--,r=[...this.words[s.index].runs()]}else r=[];else r=[...s.word.runs({end:s.offset})];e===i.ordinal?e===this.frame.length-1||w(i.word)?(o=[],i.index--):o=[...i.word.runs()]:o=[...i.word.runs({start:i.offset})];const a=this.frame.length;return this.spliceWordsWithRuns(s.index,i.index-s.index+1,[...l.consolidate(r.concat(n).concat(o))]),this.frame?this.frame.length-a:0}registerEditFilter(t){this.editFilters.push(t)}width(){return this._width}setWidth(t){this._width=t,this.layout()}children(){return[this.frame]}toggleCaret(){const t=this.caretVisible;return this.selection.start===this.selection.end&&(this.selectionJustChanged?this.selectionJustChanged=!1:this.caretVisible=!this.caretVisible),this.caretVisible!==t}getCaretCoords(t){const e=this.byOrdinal(t);let n;if(e){if(e.block&&t>0){const e=this.byOrdinal(t-1);if(e.newLine){const t=e.bounds(),s=e.parent().parent().bounds();n=new u.default(s.l,s.b,1,t.h)}else n=e.bounds(),n=new u.default(n.r,n.t,1,n.h)}else n=(n=e.bounds()).h?new u.default(n.l,n.t,1,n.h):new u.default(n.l,n.t,n.w,1);return n}}byCoordinate(t,e){let n=this.frame.byCoordinate(t,e).ordinal,s=this.getCaretCoords(n);for(;s.b<=e&&n<this.frame.length-1;)n++,s=this.getCaretCoords(n);for(;s.t>=e&&n>0;)n--,s=this.getCaretCoords(n);return this.byOrdinal(n)}drawSelection(t,e){if(this.selection.end===this.selection.start){if(this.selectionJustChanged||e&&this.caretVisible){const e=this.getCaretCoords(this.selection.start);e&&(t.save(),t.fillStyle="black",e.fill(t),t.restore())}}else{t.save(),t.fillStyle=e?"rgba(0, 100, 200, 0.3)":"rgba(160, 160, 160, 0.3)";for(const e of this.selectedRange().parts())e.bounds(!0).fill(t);t.restore()}}notifySelectionChanged(t){let e=null;const n=this;this.selectionChanged.fire((function(){return e||(e=n.selectedRange().getFormatting()),e}),t)}select(t,e,n){this.frame&&(this.selection.start=Math.max(0,t),this.selection.end=Math.min("number"==typeof e?e:this.selection.start,this.frame.length-1),n&&(this.selectionJustChanged=!0),this.caretVisible=!0,this.nextInsertFormatting={},this.notifySelectionChanged(n))}performUndo(t){const e=t?this.redo:this.undo,n=t?this.undo:this.redo,s=e.pop();s&&(s(t=>{n.push(t)}),this.layout(),this.contentChanged.fire())}canUndo(t){return t?!!this.redo.length:!!this.undo.length}transaction(t){if(this._currentTransaction)t(this._currentTransaction);else{const e=this;for(;this.undo.length>50;)e.undo.shift();this.redo.length=0;let n=!1;this.undo.push(p(s=>{e._currentTransaction=s;try{t(s)}finally{n=s.length>0,e._currentTransaction=null}})),n&&(e.layout(),e.contentChanged.fire())}}}e.CarotaDocument=m},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(0),i=function(t,e){if(t._runs!==e._runs)throw new Error("Characters for different documents")};class r{constructor(t,e,n){this._runs=t,this._run=e,this._offset=n,this.char=e>=t.length?null:s.getTextChar(t[e].text,n)}equals(t){return i(this,t),this._run===t._run&&this._offset===t._offset}*cut(t){i(this,t);const e=this;for(let n=e._run;n<=t._run;n++){const i=e._runs[n];if(i){const r=n===e._run?e._offset:0,o=n===t._run?t._offset:s.getTextLength(i.text);if(r<o)for(const t of s.getSubText(i.text,r,o-r)){const e=Object.create(i);e.text=t,yield e}}}}}e.Character=r;const o=(t,e)=>{for(;e<t.length;e++)if(0!==s.getTextLength(t[e].text))return new r(t,e,0);return new r(t,t.length,0)};e.characters=function*(t){let e=o(t,0);for(yield e;null!==e.char;)e=e._offset+1<s.getTextLength(t[e._run].text)?new r(t,e._run,e._offset+1):o(t,e._run+1),yield e}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.split=function*(t,e){let n,s=null,i=null,r=!0;for(const o of e){if(null===o.char)n=!0;else if(r&&(n=!0,r=!1),"string"==typeof o.char)switch(o.char){case" ":i||(i=o);break;case"\n":n=!0,r=!0;break;default:i&&(n=!0)}else{const e=t(o.char);(e.block||e.eof)&&(n=!0,r=!0)}if(n){if(s&&!s.equals(o)&&(yield{text:s,spaces:i||o,end:o},i=null),null===o.char)return void(yield null);s=o,n=!1}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(0),i=n(2);e.Range=class{constructor(t,e,n){this.doc=t,this.start=e,this.end=n,this.doc=t,this.start=e,this.end=n,e>n&&(this.start=n,this.end=e)}*parts(t){t=t||this.doc.children();for(const e of t)if(!(e.ordinal+e.length<=this.start)){if(e.ordinal>=this.end)break;e.ordinal>=this.start&&e.ordinal+e.length<=this.end?yield e:yield*this.parts(e.children())}}clear(){return this.setText([])}setText(t){return this.doc.splice(this.start,this.end,t)}plainText(){return[...i.gmap(this.doc.runs(this),s.getPlainText)].join("")}save(){return[...s.consolidate([...this.doc.runs(this)])]}getFormatting(){if(this.start===this.end){let t=this.start;t>0&&t--,this.start=t,this.end=t+1}return i.gfoldl(this.doc.runs(this),s.merge)||s.defaultFormatting}setFormatting(t,e){let n=this;if("align"===t&&(n=n.doc.paragraphRange(n.start,n.end)),n.start===n.end)n.doc.modifyInsertFormatting(t,e);else{const i=n.save(),r={};r[t]=e,s.format(i,r),n.setText(i)}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(16),i=n(6),r=n(5);e.default=function*(t,e,n,o,l,a,c,h,d){const u=[];let f,g,p=0,w=0,m=h||0,b=d||0,y=n;function x(t){if(u.push(t),p+=t.width,m=Math.max(m,t.ascent),b=Math.max(b,t.descent),t.isNewLine())return w=t.ascent+t.descent,_()}function _(){if(f||0===u.length)return;const t=new s.Line(a,e,o,y+m,m,b,u,l);return l+=t.length,y+=m+b,u.length=0,p=m=b=0,t}for(const s of t)if(g){w=0;const t=g(s);t&&(g=null,l+=t.length,y+=t.bounds().h,t.block=!0,yield t)}else{const t=s.code();if(t&&t.block){if(u.length){const t=_();t&&(yield t)}else y+=w;g=t.block(e,y,o,l,a,s.codeFormatting()),w=0}else if(t&&t.eof||s.eof){if(!t||c&&c(t)){const t=x(s);t&&(yield t)}if(u.length){const t=_();t&&(yield t),yield y-n}else yield y+w-n;f=!0}else if(w=0,s.text.width>o){u.length&&(yield _());const t=a.parent().codes.bind(a.parent());let e=0,n=0;for(;n<s.length;){const l=[...s.runs({start:e,end:n})];new i.Section(l.map(e=>r.part(e,t))).width>o&&(x(new i.Word(new i.Section([...s.runs({start:e,end:n-1})].map(e=>r.part(e,t))),new i.Section([]),!1)),yield _(),e=n-1),n++}x(new i.Word(new i.Section([...s.runs({start:e})].map(e=>r.part(e,t))),s.space,!1))}else if(u.length){if(p+s.text.width>o){const t=_();t&&(yield t)}const t=x(s);t&&(yield t)}else{const t=x(s);t&&(yield t)}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(17),i=n(1),r=n(3);class o extends r.Node{constructor(t,e,n,i,r,o,l,a){super("line"),this.doc=t,this.left=e,this.width=n,this.baseline=i,this.ascent=r,this.descent=o,this.ordinal=a,this.align=l[0].align();let c=0;l.forEach(t=>{c+=t.width}),c-=l[l.length-1].space.width;let h=0,d=0;if(c<n)switch(this.align){case"right":h=n-c;break;case"center":h=(n-c)/2;break;case"justify":l.length>1&&!l[l.length-1].isNewLine()&&(d=(n-c)/(l.length-1))}this.positionedWords=l.map(t=>{const e=h;h+=t.width+d;const n=a;return a+=t.text.length+t.space.length,new s.PositionedWord(t,this,e,n,t.width+d)}),this.actualWidth=c,this.length=a-this.ordinal}bounds(t){if(t){const t=this.first().bounds(),e=this.last().bounds();return new i.default(t.l,this.baseline-this.ascent,e.l+e.w-t.l,this.ascent+this.descent)}return new i.default(this.left,this.baseline-this.ascent,this.width,this.ascent+this.descent)}parent(){return this.doc}children(){return this.positionedWords}}e.Line=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(1),i=n(5),r=n(4),o=n(3),l=n(0),a=t=>r.measure(r.enter,t).width;class c extends o.Node{constructor(t,e,n,s,i){super("character"),this.left=t,this.part=e,this.word=n,this.ordinal=s,this.length=i}bounds(){const t=this.word.bounds(),e=this.word.word.isNewLine()?a(this.word.word.run):this.width||this.part.width;return new s.default(t.l+this.left,t.t,e,t.h)}parent(){return this.word}byOrdinal(){return this}byCoordinate(t,e){return t<=this.bounds().center().x?this:this.next()}}class h extends o.Node{constructor(t,e,n,s,i){super("word"),this.word=t,this.line=e,this.left=n,this.ordinal=s,this.width=i,this.length=t.text.length+t.space.length}draw(t){this.word.draw(t,this.line.left+this.left,this.line.baseline)}bounds(){return new s.default(this.line.left+this.left,this.line.baseline-this.line.ascent,this.word.isNewLine()?a(this.word.run):this.width,this.line.ascent+this.line.descent)}parts(t){this.word.text.parts.some(t)||this.word.space.parts.some(t)}realiseCharacters(){if(!this._characters){const t=[];let e=0;const n=this;let s=this.ordinal;const r=this.parentOfType("document"),o=r.codes;this.parts(a=>{l.pieceCharacters(l=>{const h=Object.create(a.run);h.text=l;const d=i.part(h,o.bind(r));t.push(new c(e,d,n,s,1)),e+=d.width,s++},a.run.text)});const a=t[t.length-1];a&&(a.width=this.width-a.left,(this.word.isNewLine()||this.word.code()&&this.word.code().eof)&&(a.newLine=!0)),this._characters=t}}children(){return this.realiseCharacters(),this._characters}parent(){return this.line}}e.PositionedWord=h},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(4),i=n(7),r=n(3),o=n(1),l=n(2);class a extends r.Node{constructor(t,e,n,s,i){super(""),this.inline=t,this._parent=e,this.ordinal=n,this.length=s,this.formatting=i,this.measured=t.measure(i)}parent(){return this._parent}draw(t){this.inline.draw(t,this.left,this.baseline,this.measured.width,this.measured.ascent,this.measured.descent,this.formatting)}position(t,e,n){this.left=t,this.baseline=e,n&&(this._bounds=n)}bounds(){return this._bounds||new o.default(this.left,this.baseline-this.measured.ascent,this.measured.width,this.measured.ascent+this.measured.descent)}byCoordinate(t,e){return t<=this.bounds().center().x?this:this.next()}}const c=function(t){return l.derive(t,{eof:!0,measure:function(t){return{width:18,ascent:0,descent:0}},draw:function(t,e,n){}})},h={number:function(t,e){const n=e+1+".";return{measure:function(t){return s.measure(n,t)},draw:function(t,e,i,r,o,l,a){s.draw(t,n,a,e,i,r,o,l)}}},listNext:c,listEnd:c,listStart:function(t,e,n){return l.derive(t,{block:function(e,s,l,c,h,d){const u=new r.GenericNode("list",h,e,s);let f,g,p;const w=function(t,o){f=new r.GenericNode("item",u);const h=n(t.marker||{$:"number"},u.children().length);(p=new a(h,f,c,1,o)).block=!0,g=new i.Framer(e+50,s,l-50,c+1,f,t=>"listEnd"===t.$,p.measured.ascent,0)};return w(t,d),function(t){if(g?g.frame(t=>{c=t.ordinal+t.length;const n=t.bounds(),i=t.first(),r=e+50-10-p.measured.width,l=new o.default(e,s,50,n.h);"baseline"in i?p.position(r,i.baseline,l):p.position(r,s+p.measured.ascent,l),s=n.t+n.h,f.children().push(p),f.children().push(t),f.finalize(),u.children().push(f),f=itemFrame=p=null},t):c++,!g){const e=t.code();if(e){if("listEnd"===e.$)return u.finalize(),u;"listNext"===e.$&&w(e,t.codeFormatting())}}}}})}};e.codes=function(t,e,n){const s=h[t.$];return s&&s(t,e,n)},e.editFilter=function(t){let e=0;if(!t.words.some((n,s)=>{const i=n.code();if(i)switch(i.$){case"listStart":e++;break;case"listNext":if(0===e)return t.spliceWordsWithRuns(s,1,[l.derive(n.codeFormatting(),{text:{$:"listStart",marker:i.marker}})]),!0;break;case"listEnd":0===e&&t.spliceWordsWithRuns(s,1,[]),e--}})&&e>0){const n=[];for(;e>0;)e--,n.push({text:{$:"listEnd"}});t.spliceWordsWithRuns(t.words.length-1,0,n)}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=n(0),i=function(t,e){return function(n,s){n.nodeName===t&&(s[e]=!0)}},r=function(t,e,n,s){return function(i,r){let o=i[t]&&i[t][e];o&&(s&&(o=s(o)),r[n]=o)}},o=function(t,e,n){return r("attributes",t,e,n)},l=function(t,e,n){return r("style",t,e,n)},a=function(t,e,n){return function(s,i){s.style&&s.style.getPropertyValue(t)===e&&(i[n]=!0)}},c=[6,7,9,10,12,16,20,30],h=["BR","P","H1","H2","H3","H4","H5"],d=["left","center","right","justify"],u=function(t){return d.includes(t)?t:"left"},f=(new Map).set("H1",30).set("H2",20).set("H3",16).set("H4",14).set("H5",12),g=function(t){const e=t.split(/\s*,\s*/g);if(0==e.length)return t;let n=(t=e[0]).match(/^"(.*)"$/);return n?n[1].trim():(n=t.match(/^'(.*)'$/))?n[1].trim():t},p=[i("B","bold"),i("STRONG","bold"),i("I","italic"),i("EM","italic"),i("U","underline"),i("S","strikeout"),i("STRIKE","strikeout"),i("DEL","strikeout"),a("fontWeight","bold","bold"),a("fontStyle","italic","italic"),a("textDecoration","underline","underline"),a("textDecoration","line-through","strikeout"),l("color","color"),l("fontFamily","font",g),l("fontSize","size",t=>{const e=t.match(/^([\d\.]+)pt$/);return e?parseFloat(e[1]):10}),l("textAlign","align",u),function(t,e){"SUB"===t.nodeName&&(e.script="sub")},function(t,e){"SUPER"===t.nodeName&&(e.script="super")},function(t,e){"CODE"===t.nodeName&&(e.font="monospace")},function(t,e){const n=f.get(t.nodeName);n&&(e.size=n)},o("color","color"),o("face","font",g),o("align","align",u),o("size","size",t=>c[t]||10)];e.parse=function(t,e){let n;"string"==typeof t?(n=document.createElement("div")).innerHTML=t:n=t;let i=!0;const r=[],o=function(t,e){r.push(Object.create(e,{text:{value:t}}))},l=(t,n)=>{if(t instanceof HTMLElement){if(n=Object.create(n),t.classList.forEach(t=>{const s=e.get(t);s&&Object.keys(s).forEach(t=>{n[t]=s[t]})}),p.forEach(e=>{e(t,n)}),t.childNodes)for(let e=0;e<t.childNodes.length;e++)l(t.childNodes[e],n);h.includes(t.nodeName)&&(o("\n",n),i=!0)}else!function(t,e){let n=(t=t.replace(/\n+\s*/g," ")).length;t=t.replace(/^\s+/,""),i?i=!1:n!==t.length&&(t=" "+t),(n=t.length)!==(t=t.replace(/\s+$/,"")).length&&(i=!0,t+=" "),o(t,e)}(t.nodeValue,n)};return l(n,{}),[...s.consolidate(r)]}}]);
